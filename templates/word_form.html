{% extends "base.html" %}

{% block content %}
    <h1>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</h1>
    
    <div class="instructions">
        <h3>üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
        <ol>
            <li>–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</li>
            <li>–ü–µ—Ä–µ–≤–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
        </ol>
    </div>

    <form method="post" id="word-form">{% csrf_token %}
        <div>
            <label for="id_text">Text:</label>
            <div class="input-group">
                <input type="text" name="text" id="id_text" maxlength="255" required>
                <button type="button" id="lang-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫">üá∑üá∫</button>
                <button type="button" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
                <button type="button" id="play-word-audio" title="–û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ">üîä</button>
            </div>
            <small id="voice-status" class="voice-status"></small>
        </div>

        <div>
            <label for="id_translation">Translation:</label>
            <div class="input-group">
                <input type="text" name="translation" id="id_translation" maxlength="255" required>
                <button type="button" id="play-translation-audio" title="–û–∑–≤—É—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥">üîä</button>
            </div>
        </div>

        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>


    <style>
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        voice-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        voice-btn:hover {
            background: #218838;
        }
        voice-btn:active, #voice-btn.recording {
            background: #dc3545;
        }

        .voice-status {
            color: #666;
            font-style: italic;
        }
        #translate-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        #translate-btn:hover {
            background: #0056b3;
        }
        #translate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button[type="submit"] {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button[type="submit"]:hover {
            background: #218838;
        }
        .instructions {
            background: #e9ecef;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .instructions h3 {
            margin-top: 0;
            color: #495057;
        }
        .instructions ol {
            margin-bottom: 0;
        }
    </style>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const textInput = document.getElementById('id_text');
    const translationInput = document.getElementById('id_translation');
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');
    const playWordAudio = document.getElementById('play-word-audio');
    const playTranslationAudio = document.getElementById('play-translation-audio');
    const langToggle = document.getElementById('lang-toggle'); // ‚Üê –î–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É!

    // --- –ì–û–õ–û–°–û–í–û–ô –í–í–û–î ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let currentLang = 'ru-RU'; // üåê –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLang; // üîä –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫

        recognition.onstart = () => {
            voiceBtn.classList.add('recording');
            voiceBtn.textContent = 'üü§';
            voiceStatus.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            textInput.value = transcript;
            voiceStatus.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}"`;
            textInput.dispatchEvent(new Event('input', { bubbles: true }));
        };

        recognition.onerror = (event) => {
            voiceStatus.textContent = `–û—à–∏–±–∫–∞: ${event.error}`;
        };

        recognition.onend = () => {
            voiceBtn.classList.remove('recording');
            voiceBtn.textContent = 'üé§';
            setTimeout(() => {
                if (voiceStatus.textContent.includes('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ')) {
                    voiceStatus.textContent = '';
                }
            }, 3000);
        };

        voiceBtn.addEventListener('click', () => {
            recognition.lang = currentLang; // üîÑ –ü–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫
            recognition.start();
        });
    } else {
        voiceBtn.style.display = 'none';
        voiceStatus.textContent = '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
    }

    // --- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –Ø–ó–´–ö–ê ---
    if (langToggle) {
        langToggle.addEventListener('click', () => {
            if (currentLang === 'ru-RU') {
                currentLang = 'en-US';
                langToggle.textContent = 'üá∫üá∏';
                langToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–∏–π';
            } else {
                currentLang = 'ru-RU';
                langToggle.textContent = 'üá∑üá∫';
                langToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π';
            }
            if (recognition) {
                recognition.lang = currentLang; // üîÑ –ú–µ–Ω—è–µ–º —è–∑—ã–∫ –≤ –¥–≤–∏–∂–∫–µ
            }
            console.log('–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + currentLang);
        });
    } else {
        console.warn('–ö–Ω–æ–ø–∫–∞ lang-toggle –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // --- –û–ó–í–£–ß–ö–ê –°–õ–û–í–ê ---
    playWordAudio.addEventListener('click', () => {
        const text = textInput.value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –æ–∑–≤—É—á–∫–∏');
            return;
        }
        const lang = text.match(/[–∞-—è—ë]/i) ? 'ru' : 'en';
        const audio = new Audio(`/words/speak/?text=${encodeURIComponent(text)}&lang=${lang}`);
        audio.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
    });

    // --- –û–ó–í–£–ß–ö–ê –ü–ï–†–ï–í–û–î–ê ---
    playTranslationAudio.addEventListener('click', () => {
        const text = translationInput.value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è –æ–∑–≤—É—á–∫–∏');
            return;
        }
        const lang = text.match(/[–∞-—è—ë]/i) ? 'ru' : 'en';
        const audio = new Audio(`/words/speak/?text=${encodeURIComponent(text)}&lang=${lang}`);
        audio.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
    });

    // --- –ê–í–¢–û–ü–ï–†–ï–í–û–î –° –î–ï–ë–ê–£–ù–°–û–ú ---
    let debounceTimer;
    textInput.addEventListener('input', function () {
        const text = textInput.value.trim();
        clearTimeout(debounceTimer);
        if (!text || translationInput.value.trim()) return;

        debounceTimer = setTimeout(() => {
            fetch('/words/translate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.translation) {
                    translationInput.value = data.translation;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
            });
        }, 800);
    });
});

    </script>
{% endblock %}


