{% extends "base.html" %}

{% block content %}
    <h1>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</h1>
    
    <div class="instructions">
        <h3>üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
        <ol>
            <li>–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∏–ª–∏ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</li>
            <li>–ü–µ—Ä–µ–≤–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12) –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</li>
        </ol>
    </div>
    <form method="post" id="word-form">{% csrf_token %}
        <div>
            <label for="id_text">Text:</label>
            <div class="input-group">
                <input type="text" name="text" id="id_text" maxlength="255" required>
                <button type="button" id="lang-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫">üá∑üá∫</button>
                <button type="button" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
            </div>
            <small id="voice-status" class="voice-status"></small>
        </div>
        <div>
            <label for="id_translation">Translation:</label>
            <input type="text" name="translation" id="id_translation" maxlength="255" required>
            <button type="button" id="translate-btn">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
            <button type="button" id="test-api-btn" style="background: #6c757d; margin-left: 10px;">–¢–µ—Å—Ç API</button>
            <button type="button" id="force-translate-btn" style="background: #28a745; margin-left: 10px;">–ü—Ä–∏–Ω—É–¥–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        </div>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
    
    <style>
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #voice-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #voice-btn:hover {
            background: #218838;
        }
        #voice-btn:active, #voice-btn.recording {
            background: #dc3545;
        }
        #lang-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #lang-toggle:hover {
            background: #545b62;
        }
        .voice-status {
            color: #666;
            font-style: italic;
        }
        #translate-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        #translate-btn:hover {
            background: #0056b3;
        }
        #translate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button[type="submit"] {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button[type="submit"]:hover {
            background: #218838;
        }
        .instructions {
            background: #e9ecef;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .instructions h3 {
            margin-top: 0;
            color: #495057;
        }
        .instructions ol {
            margin-bottom: 0;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const textInput = document.getElementById('id_text');
        const translationInput = document.getElementById('id_translation');
        const translateBtn = document.getElementById('translate-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const voiceStatus = document.getElementById('voice-status');
        const langToggle = document.getElementById('lang-toggle');
        
        // –¢–µ–∫—É—â–∏–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        let currentLang = 'ru-RU';
        
        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
        if (langToggle) {
            langToggle.addEventListener('click', function() {
                if (currentLang === 'ru-RU') {
                    currentLang = 'en-US';
                    langToggle.textContent = 'üá∫üá∏';
                    langToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–∏–π';
                } else {
                    currentLang = 'ru-RU';
                    langToggle.textContent = 'üá∑üá∫';
                    langToggle.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π';
                }
                if (recognition) {
                    recognition.lang = currentLang;
                }
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLang; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫
            
            recognition.onstart = function() {
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = 'üü§'; // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä—É–∂–æ–∫
                voiceStatus.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                textInput.value = transcript;
                voiceStatus.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "' + transcript + '"';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º
                if (transcript && !translationInput.value.trim()) {
                    setTimeout(translateWord, 500);
                }
            };
            
            recognition.onerror = function(event) {
                voiceStatus.textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + event.error;
            };
            
            recognition.onend = function() {
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§';
                if (!voiceStatus.textContent.includes('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ')) {
                    voiceStatus.textContent = '';
                }
            };
            
            voiceBtn.addEventListener('click', function() {
                if (recognition && !voiceBtn.classList.contains('recording')) {
                    recognition.start();
                }
            });
        } else {
            voiceBtn.style.display = 'none';
            voiceStatus.textContent = '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º';
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        async function translateWord() {
            const text = textInput.value.trim();
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞');
                return;
            }
            
            console.log('[DEBUG] Starting translation for:', text);
            
            translateBtn.disabled = true;
            translateBtn.textContent = '–ü–µ—Ä–µ–≤–æ–¥–∏–º...';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å
            if (voiceStatus) {
                voiceStatus.textContent = '–ü–µ—Ä–µ–≤–æ–¥–∏–º —Å–ª–æ–≤–æ...';
                voiceStatus.style.color = '#007bff';
            }
            
            try {
                const requestData = { text: text };
                console.log('[DEBUG] Sending request:', requestData);
                
                const response = await fetch('/words/translate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('[DEBUG] Response status:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);
                
                if (response.ok) {
                    translationInput.value = data.translation || '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–µ–≤–æ–¥–µ
                    let statusMsg = `‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: ${data.translation}`;
                    if (data.note) {
                        statusMsg += ` (${data.note})`;
                    }
                    
                    if (voiceStatus) {
                        voiceStatus.textContent = statusMsg;
                        voiceStatus.style.color = '#28a745';
                        setTimeout(() => {
                            if (voiceStatus.textContent === statusMsg) {
                                voiceStatus.textContent = '';
                                voiceStatus.style.color = '#666';
                            }
                        }, 3000);
                    }
                } else {
                    const errorMsg = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    console.error('[ERROR] Translation failed:', data);
                    
                    if (voiceStatus) {
                        voiceStatus.textContent = `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${errorMsg}`;
                        voiceStatus.style.color = '#dc3545';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
                    if (data.suggestion) {
                        console.log('[SUGGESTION]', data.suggestion);
                    }
                }
            } catch (error) {
                console.error('[ERROR] Network error:', error);
                const errorText = `üåê –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
                
                if (voiceStatus) {
                    voiceStatus.textContent = errorText;
                    voiceStatus.style.color = '#dc3545';
                } else {
                    alert(errorText);
                }
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
            }
        }
        
        translateBtn.addEventListener('click', translateWord);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏
        const testApiBtn = document.getElementById('test-api-btn');
        testApiBtn.addEventListener('click', async function() {
            console.log('[TEST] Testing API directly...');
            
            try {
                const testResponse = await fetch('/words/translate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: '–ø—Ä–æ–¥–∞–∂–∞' })
                });
                
                const testData = await testResponse.json();
                console.log('[TEST] API response:', testData);
                alert(`API —Ç–µ—Å—Ç: "–ø—Ä–æ–¥–∞–∂–∞" -> "${testData.translation || '–û—à–∏–±–∫–∞: ' + testData.error}"`);
                
            } catch (error) {
                console.error('[TEST] API test failed:', error);
                alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ API: ' + error.message);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        const forceTranslateBtn = document.getElementById('force-translate-btn');
        forceTranslateBtn.addEventListener('click', function() {
            console.log('[FORCE] Force translate triggered');
            translationInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞
            translateWord(); // –í—ã–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏ –≤–≤–æ–¥–µ
        let timeoutId;
        textInput.addEventListener('input', function() {
            const currentText = textInput.value.trim();
            const currentTranslation = translationInput.value.trim();
            
            console.log('[DEBUG] Input event triggered:', {
                text: currentText,
                translation: currentTranslation,
                shouldTranslate: currentText && !currentTranslation
            });
            
            clearTimeout(timeoutId);
            
            if (currentText && !currentTranslation) {
                console.log('[DEBUG] Setting translation timeout...');
                timeoutId = setTimeout(() => {
                    console.log('[DEBUG] Timeout executed, calling translateWord()');
                    translateWord();
                }, 1500); // –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 1.5 —Å–µ–∫
            } else {
                console.log('[DEBUG] Auto-translation not triggered');
            }
        });
    });
    </script>
{% endblock %}
